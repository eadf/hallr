permissions:
  contents: write

name: Rust_release

on:
  release:
    types: [published]

env:
  CARGO_TERM_COLOR: always

jobs:
  build_platforms:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            os_short: win64
            lib_extension: dll
            lib_prefix: ""
          - os: ubuntu-latest
            os_short: linux64
            lib_extension: so
            lib_prefix: lib

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Rust library
        run: |
          cargo rustc --release --crate-type=cdylib -- -C opt-level=3 -C lto=fat

        shell: bash
        working-directory: ${{ github.workspace }}

      - name: Install zip (Windows)
        if: runner.os == 'Windows'
        run: choco install zip -y

      - name: Create platform directory structure
        run: |
          mkdir -p platform_build/hallr/lib
          # create a dummy file for folder protection
          cp blender_addon/.hallr platform_build/hallr/
          if [ ! -f "platform_build/hallr/.hallr" ]; then
            touch platform_build/hallr/.hallr
          fi
          # Copy Python files
          cp blender_addon/*.py platform_build/hallr/
          # Copy compiled library
          cp target/release/${{ matrix.lib_prefix }}hallr.${{ matrix.lib_extension }} platform_build/hallr/lib/${{ matrix.lib_prefix }}hallr.${{ matrix.lib_extension }}
          # list to verify
          echo "Contents of platform_build:"
          find platform_build -type f | sort
        shell: bash
        working-directory: ${{ github.workspace }}

      - name: Create platform zip (versioned)
        run: |
          TAG="${{ github.event.release.tag_name }}"
          ZIPNAME="hallr_${TAG}_${{ matrix.os_short }}.zip"
          cd platform_build
          # remove any .DS_Store or __MACOSX if present
          zip -r "${{ github.workspace }}/${ZIPNAME}" hallr -x "*.DS_Store" -x "__MACOSX/*"
          
          cd "${{ github.workspace }}"
          ls -lh "${ZIPNAME}"
        shell: bash
        working-directory: ${{ github.workspace }}

      - name: Upload platform artifact (zip)
        uses: actions/upload-artifact@v4
        with:
          name: hallr_${{ github.event.release.tag_name }}_${{ matrix.os_short }}
          path: |
            hallr_${{ github.event.release.tag_name }}_${{ matrix.os_short }}.zip
          include-hidden-files: true

  build_macos_universal:
    name: Build macOS Universal
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install targets
        run: |
          rustup target add x86_64-apple-darwin
          rustup target add aarch64-apple-darwin

      - name: Build x86_64
        run: |
          cargo rustc --release --target x86_64-apple-darwin --crate-type="cdylib" -- -C opt-level=3 -C lto=fat

      - name: Build aarch64
        run: |
          cargo rustc --release --target aarch64-apple-darwin --crate-type="cdylib" -- -C opt-level=3 -C lto=fat

      - name: Create universal library and zip (versioned)
        run: |
          mkdir -p platform_build/hallr/lib
          # create a dummy file for folder protection
          cp blender_addon/.hallr platform_build/hallr/
          if [ ! -f "platform_build/hallr/.hallr" ]; then
            touch platform_build/hallr/.hallr
          fi
          # Copy Python files
          cp blender_addon/*.py platform_build/hallr/
          # Create universal binary
          lipo -create \
            -output platform_build/hallr/lib/libhallr.dylib \
            target/x86_64-apple-darwin/release/libhallr.dylib \
            target/aarch64-apple-darwin/release/libhallr.dylib

          # Verify
          lipo -info platform_build/hallr/lib/libhallr.dylib

          # Create zip with versioned name
          TAG="${{ github.event.release.tag_name }}"
          ZIPNAME="hallr_${TAG}_mac_universal.zip"
          cd platform_build
          zip -r "${{ github.workspace }}/${ZIPNAME}" hallr -x "*.DS_Store" -x "__MACOSX/*"
          
          cd "${{ github.workspace }}"
          ls -lh "${ZIPNAME}"
        shell: bash
        working-directory: ${{ github.workspace }}

      - name: Upload macOS artifact (zip)
        uses: actions/upload-artifact@v4
        with:
          name: hallr_${{ github.event.release.tag_name }}_mac_universal
          path: |
            hallr_${{ github.event.release.tag_name }}_mac_universal.zip
          include-hidden-files: true

  combine_artifacts:
    name: Combine platform artifacts & upload release assets
    needs: [build_platforms, build_macos_universal]
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_artifacts
          pattern: "hallr_*"
          merge-multiple: true

      - name: List downloaded artifacts
        run: |
          echo "Downloaded files:"
          find all_artifacts -maxdepth 2 -type f -name "*.zip" -print | sort
        shell: bash

      - name: Create combined (allplatforms) directory
        run: |
          TAG="${{ github.event.release.tag_name }}"
          mkdir -p combined_build/hallr/lib
          touch combined_build/hallr/.hallr
          touch combined_build/.hallr

          # Unzip each platform zip into a temporary area, but avoid overwriting python files
          # We'll extract libraries into combined_build/hallr/lib and copy python once
          for z in all_artifacts/*.zip; do
            echo "Processing ${z}"
            tmpdir=$(mktemp -d)
            unzip -q "$z" -d "$tmpdir"
            # copy python files (if not already present)
            if [ -d "$tmpdir/hallr" ]; then
              cp -n $tmpdir/hallr/*.py combined_build/hallr/ || true
              # copy libs
              find $tmpdir/hallr/lib -type f -exec cp {} combined_build/hallr/lib/ \; || true
            fi
            rm -rf "$tmpdir"
          done

          echo "Combined build tree:"
          find combined_build -type f | sort

          # Create combined zip (allplatforms)
          ALLZIP="hallr_${TAG}_allplatforms.zip"
          cd combined_build
          zip -r "../${ALLZIP}" hallr -x "*.DS_Store" -x "__MACOSX/*"
          cd "${{ github.workspace }}"
          ls -lh "${ALLZIP}"
        shell: bash
        working-directory: ${{ github.workspace }}

      - name: Prepare list of release assets to upload
        run: |
          TAG="${{ github.event.release.tag_name }}"
          # Find all versioned zips in workspace root (downloaded artifacts will be in all_artifacts or root)
          # Move any zips from all_artifacts to workspace root so gh can upload them easily
          find all_artifacts -type f -name "hallr_${TAG}_*.zip" -exec cp {} . \;
          echo "Files to upload:"
          ls -1 hallr_${TAG}_*.zip || true
        shell: bash

      - name: Upload release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.event.release.tag_name }}"
          # Upload each file (skip if not present)
          for f in hallr_${TAG}_*.zip; do
            if [ -f "$f" ]; then
              echo "Uploading $f to release ${TAG}"
              gh release upload "${TAG}" "$f" --clobber
            else
              echo "Skipping $f (not found)"
            fi
          done
        shell: bash

